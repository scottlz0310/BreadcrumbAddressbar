# PySide6/PyQt6 パンくずリスト型アドレスバー ライブラリ仕様書

## 概要
ファイルマネージャー向けのパンくずリスト型アドレスバーライブラリ。アドレスバーの拡張として階層的なナビゲーションを提供する。

## ライブラリ設計方針

### 既存アプリへの導入しやすさ
- **最小限の依存関係**: PySide6/PyQt6以外の追加依存なし
- **簡単な組み込み**: 既存のQWidgetレイアウトに数行で追加可能
- **段階的導入**: 基本機能から始めて段階的に機能拡張
- **既存コードの流用**: 既存のファイル操作ロジックをそのまま活用
- **カスタマイズ性**: 既存アプリのデザイン・動作に合わせて調整可能

### 設定管理
- **設定ファイル**: JSON/INI形式での設定保存・読み込み
- **実行時設定**: APIを通じた動的な設定変更
- **設定の永続化**: アプリケーション終了時の設定自動保存
- **デフォルト設定**: 合理的なデフォルト値による即座の利用開始
- **設定のバリデーション**: 不正な設定値の自動補正・エラーハンドリング

## 基本要件

### 用途・目的
- **主要用途**: ファイルマネージャーでのフォルダ選択ナビゲーション
- **コンセプト**: アドレスバーの拡張版として動作
- **対象プラットフォーム**: マルチプラットフォーム対応（Windows, macOS, Linux）

### 基本動作
- **階層ナビゲーション**: フォルダ階層をボタン形式で表示
- **親階層移動**: 親階層のボタンクリックで該当フォルダに直接移動
- **最下層操作**: 最下層（現在フォルダ）ボタンクリックでフォルダ選択一覧をポップアップ表示

## 詳細機能要件

### 表示・レイアウト
- **省略パターン**: 初期化エリア内で真ん中を省略（ルート + ... + 親フォルダ + 現在フォルダ）
- **ボタン高さ**: 設定で可変
- **フォントサイズ**: 設定で可変
- **区切り文字**: カスタマイズ可能、デフォルトはボタンのみ（区切り文字なし）
- **アイコン表示**: フォルダアイコン、カスタムアイコン対応
- **長いフォルダ名**: 省略表示とツールチップ対応

### 操作系機能
- **キーボードナビゲーション**: Tab移動、矢印キー、Enter確定
- **右クリックメニュー**: コピー、新規フォルダ作成、プロパティなど
- **ドラッグ&ドロップ**: フォルダをドロップして移動
- **ホバー効果**: マウスオーバー時の視覚的フィードバック
- **フォーカス状態**: キーボードフォーカス時の表現

### 拡張機能
- **履歴機能**: 戻る/進むボタン
- **お気に入り/ブックマーク**: よく使うパスの保存・呼び出し
- **パス直接入力モード**: アドレスバー形式での直接パス入力
- **フォルダ選択一覧**: 最下層ボタンクリック時のポップアップメニュー

### エラーハンドリング
- **存在しないパス**: エラー表示、自動補正
- **アクセス権限エラー**: 適切なエラーメッセージ表示
- **非同期処理**: フォルダ存在チェックの非同期実行

### パフォーマンス
- **大量階層対応**: 深い階層構造での性能最適化
- **メモリ効率**: 不要なオブジェクトの適切な開放
- **レスポンシブ**: UI操作の応答性確保

## テーマ・スタイリング

### テーマ対応
- **システムテーマ**: OS標準テーマへの自動適応
- **ダークモード**: ライト/ダークモード対応
- **カスタムテーマ**: qt-theme-managerライブラリとの連携

### スタイルカスタマイズ
- **カスタムスタイルシート**: 独自CSS適用のしやすさ
- **色設定**: ボタン色、背景色、テキスト色のカスタマイズ
- **境界線**: ボーダーの太さ、色、スタイル設定
- **余白・間隔**: パディング、マージンの調整

## API設計方針

### 基本クラス構成
```python
BreadcrumbAddressBar  # メインクラス
├── BreadcrumbItem    # 個別ボタンクラス
├── PopupMenu         # フォルダ選択ポップアップ
└── HistoryManager    # 履歴管理クラス
```

### 主要メソッド

#### パス操作
- `setPath(path)`: パス設定
- `getPath()`: 現在パス取得
- `navigateUp()`: 親ディレクトリに移動
- `navigateToRoot()`: ルートディレクトリに移動

#### 表示・スタイル設定
- `setCustomLabels(labels)`: カスタムラベル設定
- `setMaxItems(count)`: 最大表示項目数設定
- `setSeparator(separator)`: 区切り文字設定
- `setButtonHeight(height)`: ボタン高さ設定
- `setFontSize(size)`: フォントサイズ設定
- `setTheme(theme)`: テーマ設定
- `setStyleSheet(css)`: カスタムスタイル適用

#### 設定管理
- `loadSettings(file_path)`: 設定ファイル読み込み
- `saveSettings(file_path)`: 設定ファイル保存
- `getSettings()`: 現在設定の取得
- `setSettings(settings_dict)`: 設定一括適用
- `resetToDefaults()`: デフォルト設定にリセット

#### 機能制御
- `enableHistory(enabled)`: 履歴機能の有効/無効
- `enableBookmarks(enabled)`: ブックマーク機能の有効/無効
- `enableRightClick(enabled)`: 右クリックメニューの有効/無効
- `enableDragDrop(enabled)`: ドラッグ&ドロップの有効/無効

### シグナル
- `pathChanged(path)`: パス変更通知
- `folderSelected(path)`: フォルダ選択通知
- `rightClicked(path)`: 右クリック通知
- `dragDropped(source, target)`: ドラッグ&ドロップ通知

## 実装優先度

### Phase 1 (最小機能)
- 基本的なパンくずリスト表示
- クリックナビゲーション
- 省略表示機能
- 基本スタイリング

### Phase 2 (中核機能)
- フォルダ選択ポップアップ
- キーボードナビゲーション
- テーマ対応
- 設定可能なボタンサイズ・フォント

### Phase 3 (拡張機能)
- 履歴機能
- 右クリックメニュー
- ドラッグ&ドロップ
- パス直接入力モード

### Phase 4 (高度機能)
- お気に入り機能
- 非同期処理
- パフォーマンス最適化
- 高度なエラーハンドリング

## 技術検討事項

### Qt互換性
- PySide6/PyQt6/PyQt5の自動検出
- バージョン間の差異吸収
- 非推奨APIの回避

### マルチプラットフォーム
- パス区切り文字の自動判定（`/` vs `\`）
- システムアイコンの取得方法
- フォント設定の差異対応

### パフォーマンス考慮
- 遅延読み込み（Lazy Loading）
- キャッシュ機構
- メモリリーク対策

## 設計上の制約・注意点

- Qtのイベントループに依存する非同期処理
- プラットフォーム固有のファイルシステム制限
- 大量のフォルダを含む階層での表示制限
- アクセス権限によるフォルダ読み取り制限

## 使用例・導入方法

### 基本的な使用方法
```python
# 1. インストール
# pip install breadcrumb-addressbar

# 2. 基本的な組み込み（最小3行）
from breadcrumb_addressbar import BreadcrumbAddressBar

self.addressbar = BreadcrumbAddressBar()
self.addressbar.pathChanged.connect(self.navigate_to_folder)  # 既存メソッドに接続
layout.addWidget(self.addressbar)  # 既存レイアウトに追加
```

### 設定ファイルの使用
```python
# settings.json
{
    "button_height": 32,
    "font_size": 12,
    "max_items": 5,
    "separator": " > ",
    "theme": "dark",
    "enable_history": true,
    "enable_bookmarks": false,
    "custom_labels": {
        "Documents": "ドキュメント",
        "Pictures": "画像"
    }
}

# Pythonでの読み込み
addressbar = BreadcrumbAddressBar()
addressbar.loadSettings("settings.json")
```

### 段階的な機能拡張
```python
# Phase 1: 基本機能のみ
addressbar = BreadcrumbAddressBar()
addressbar.setPath("/home/user/documents")

# Phase 2: 見た目のカスタマイズ
addressbar.setButtonHeight(40)
addressbar.setTheme("dark")

# Phase 3: 拡張機能の有効化
addressbar.enableHistory(True)
addressbar.enableBookmarks(True)
addressbar.historyBack.connect(self.on_history_back)
```

---

## ステアリング（開発指針・振る舞い指定）

### UI/UX基本方針
- ユーザーの直感的操作を最優先とし、学習コストを最小化すること
- クリック操作は即座に反応し、ユーザーが迷わない明確なフィードバックを提供すること
- 最下層ボタンクリック時のポップアップは、フォルダが存在する場合のみ表示すること
- 長時間の処理（フォルダスキャン等）には必ず進捗表示またはローディング表示を行うこと

### パフォーマンス方針
- UI更新は非同期で行い、メインスレッドをブロックしないこと
- フォルダ階層が深い場合（10階層以上）でも1秒以内に表示完了すること
- メモリ使用量は現在表示中の階層+履歴分のみに制限し、不要なオブジェクトは即座に解放すること
- ファイルシステムアクセスは必要最小限に留め、キャッシュを積極的に活用すること

### エラーハンドリング方針
- ファイルシステムエラー（アクセス権限、パス不存在等）は例外を投げずに適切なフォールバック処理を行うこと
- エラー時は元の状態を保持し、ユーザーが作業を継続できるよう配慮すること
- ログ出力は loggingモジュールを使用し、デバッグ用print文は禁止
- 権限エラー時はユーザーに分かりやすいメッセージで説明すること

### 拡張性・保守性方針
- 新機能追加時は既存APIの破壊的変更を避け、後方互換性を維持すること
- 設定項目追加時は必ずデフォルト値を提供し、既存の動作を変更しないこと
- プラットフォーム固有の処理は抽象化し、条件分岐を最小化すること
- テスタビリティを考慮し、外部依存（ファイルシステム等）は注入可能な設計とすること

### Qt統合方針
- Qtのシグナル・スロット機構を最大限活用し、直接的なメソッド呼び出しは避けること
- スタイルシートは実行時変更可能な設計とし、ハードコード化を禁止
- 親ウィジェットのテーマ変更に自動追従できるよう、システムパレットを優先使用すること
- メモリリーク防止のため、parent-child関係を適切に設定し、手動delete処理は最小化すること

### コード品質方針
- 1つのメソッドは単一責務とし、50行を超える場合は分割を検討すること
- 型ヒントを必須とし、dynamic typing の乱用は禁止
- 設定値のバリデーションは設定時に行い、実行時エラーを事前に防ぐこと
- 公開APIは docstring必須、内部実装の詳細は公開しないこと

**TODO**: 上記要件から取捨選択を行い、実装範囲を確定する